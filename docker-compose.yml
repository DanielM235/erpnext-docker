# ERPNext Production Docker Compose Configuration
# =================================================================
# Production-ready Docker Compose setup for ERPNext v16.0.1
# Based on official Frappe Docker repository guidelines
# Optimized for Debian 12 with host-level Nginx reverse proxy
# 
# Architecture:
# - ERPNext Backend (Gunicorn application server)
# - ERPNext Frontend (Nginx web server)
# - MariaDB (Database - officially recommended by Frappe)
# - Redis Cache (Session and object caching)
# - Redis Queue (Background job processing)
# - WebSocket (Real-time communications)
# - Scheduler (Scheduled tasks)
# - Queue Workers (Background job processing)
# - Configurator (Initial setup and site management)
#
# v16 Changes from v15:
# - Updated to Python 3.12+ and Node 22+
# - Improved WebSocket handling
# - Enhanced Redis configuration with FRAPPE_REDIS_* environment variables
# - Better platform support (linux/amd64, linux/arm64)
# - Updated default resource limits
# =================================================================

# Docker Compose version 2.x syntax (no version field needed)
# Uses modern Docker Compose features and best practices
name: ${COMPOSE_PROJECT_NAME:-erpnext-prod}

# =================================================================
# YAML Anchors for DRY Configuration
# =================================================================
x-customizable-image: &customizable_image
  image: frappe/erpnext:v${ERPNEXT_VERSION:-16.0.1}
  pull_policy: ${PULL_POLICY:-always}

x-common-settings: &common_settings
  restart: ${RESTART_POLICY:-unless-stopped}
  security_opt:
    - no-new-privileges:true
  networks:
    - frappe_network
  logging:
    driver: "json-file"
    options:
      max-size: "${LOG_MAX_SIZE:-10m}"
      max-file: "${LOG_MAX_FILES:-5}"

x-backend-defaults: &backend_defaults
  <<: [*customizable_image, *common_settings]
  platform: linux/amd64
  volumes:
    - erpnext_sites:/home/frappe/frappe-bench/sites:rw
    - erpnext_logs:/home/frappe/frappe-bench/logs:rw

x-redis-environment: &redis_environment
  FRAPPE_REDIS_CACHE: redis://redis-cache:6379
  FRAPPE_REDIS_QUEUE: redis://redis-queue:6379

services:
  # =================================================================
  # ERPNext Configurator and Site Management
  # =================================================================
  # Handles initial setup, site creation, and configuration management
  # Runs once during deployment and exits on completion
  configurator:
    <<: *customizable_image
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_configurator
    platform: linux/amd64
    
    restart: "on-failure"
    
    networks:
      - frappe_network
    
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
      restart_policy:
        condition: none
    
    security_opt:
      - no-new-privileges:true
    
    volumes:
      - erpnext_sites:/home/frappe/frappe-bench/sites:rw
      - erpnext_logs:/home/frappe/frappe-bench/logs:rw
    
    environment:
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
      REDIS_CACHE: redis-cache:6379
      REDIS_QUEUE: redis-queue:6379
      SOCKETIO_PORT: "9000"
    
    entrypoint:
      - bash
      - -c
    
    # Configuration commands based on official frappe_docker
    # Sets up common_site_config.json for all services
    command:
      - >
        ls -1 apps > sites/apps.txt;
        bench set-config -g db_host $$DB_HOST;
        bench set-config -gp db_port $$DB_PORT;
        bench set-config -g redis_cache "redis://$$REDIS_CACHE";
        bench set-config -g redis_queue "redis://$$REDIS_QUEUE";
        bench set-config -g redis_socketio "redis://$$REDIS_QUEUE";
        bench set-config -gp socketio_port $$SOCKETIO_PORT;
    
    depends_on: {}
    
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-configurator"

  # =================================================================
  # Site Creator Service
  # =================================================================
  # Creates the ERPNext site after configuration is complete
  create-site:
    <<: *customizable_image
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_create_site
    platform: linux/amd64
    
    restart: "no"
    
    networks:
      - frappe_network
    
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
      restart_policy:
        condition: none
    
    security_opt:
      - no-new-privileges:true
    
    volumes:
      - erpnext_sites:/home/frappe/frappe-bench/sites:rw
      - erpnext_logs:/home/frappe/frappe-bench/logs:rw
    
    entrypoint:
      - bash
      - -c
    
    command:
      - >
        wait-for-it -t 120 db:3306;
        wait-for-it -t 120 redis-cache:6379;
        wait-for-it -t 120 redis-queue:6379;
        export start=`date +%s`;
        until [[ -n `grep -hs ^ sites/common_site_config.json | jq -r ".db_host // empty"` ]] && \
              [[ -n `grep -hs ^ sites/common_site_config.json | jq -r ".redis_cache // empty"` ]] && \
              [[ -n `grep -hs ^ sites/common_site_config.json | jq -r ".redis_queue // empty"` ]];
        do
          echo "Waiting for sites/common_site_config.json to be created";
          sleep 5;
          if (( `date +%s`-start > 120 )); then
            echo "could not find sites/common_site_config.json with required keys";
            exit 1
          fi
        done;
        echo "sites/common_site_config.json found";
        if [[ ! -d "sites/${SITE_NAME}" ]]; then
          echo "Creating site ${SITE_NAME}...";
          bench new-site --mariadb-user-host-login-scope='%' --admin-password=${ADMIN_PASSWORD} --db-root-username=root --db-root-password=${DB_ROOT_PASSWORD} --install-app erpnext --set-default ${SITE_NAME};
        else
          echo "Site ${SITE_NAME} already exists, skipping creation";
        fi
    
    environment:
      SITE_NAME: ${SITE_NAME:-frontend}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin}
      DB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    
    depends_on:
      configurator:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
      redis-queue:
        condition: service_healthy
    
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-create-site"

  # =================================================================
  # ERPNext Backend Application Server
  # =================================================================
  # Handles API requests, web interface, and business logic
  # Runs Gunicorn WSGI server with Frappe framework
  backend:
    <<: *backend_defaults
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_backend
    
    # Production resource limits to prevent resource exhaustion
    deploy:
      resources:
        limits:
          cpus: '${BACKEND_CPU_LIMIT:-2.0}'
          memory: ${BACKEND_MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${BACKEND_CPU_RESERVE:-0.5}'
          memory: ${BACKEND_MEMORY_RESERVE:-1G}
      restart_policy:
        condition: on-failure
    
    # Health check to monitor application status
    # Uses the site name from SITE_NAME environment variable in the Host header
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -H 'Host: ${SITE_NAME:-frontend}' http://localhost:8000/api/method/frappe.ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    
    expose:
      - "8000"
    
    depends_on:
      configurator:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
      redis-queue:
        condition: service_healthy
  
  # =================================================================
  # ERPNext Frontend Web Server
  # =================================================================
  # Nginx server for static files and reverse proxy to backend
  # Handles file uploads, static assets, and HTTP request routing
  frontend:
    <<: *customizable_image
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_frontend
    platform: linux/amd64
    
    restart: ${RESTART_POLICY:-unless-stopped}
    
    networks:
      - frappe_network
    
    # Resource limits for nginx frontend (typically lighter than backend)
    deploy:
      resources:
        limits:
          cpus: '${FRONTEND_CPU_LIMIT:-1.0}'
          memory: ${FRONTEND_MEMORY_LIMIT:-1G}
      restart_policy:
        condition: on-failure
    
    # Health check for nginx web server
    # Uses the site name from SITE_NAME environment variable in the Host header
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -H 'Host: ${SITE_NAME:-frontend}' http://localhost:8080 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    
    security_opt:
      - no-new-privileges:true
    
    # Expose port for host nginx reverse proxy
    ports:
      - "${FRONTEND_PORT:-8080}:8080"
    
    volumes:
      - erpnext_sites:/home/frappe/frappe-bench/sites:ro
      - erpnext_logs:/home/frappe/frappe-bench/logs:rw
    
    # Nginx-specific configuration
    environment:
      BACKEND: backend:8000
      SOCKETIO: websocket:9000
      FRAPPE_SITE_NAME_HEADER: ${FRAPPE_SITE_NAME_HEADER:-$$host}
      UPSTREAM_REAL_IP_ADDRESS: ${UPSTREAM_REAL_IP_ADDRESS:-127.0.0.1}
      UPSTREAM_REAL_IP_HEADER: ${UPSTREAM_REAL_IP_HEADER:-X-Forwarded-For}
      UPSTREAM_REAL_IP_RECURSIVE: ${UPSTREAM_REAL_IP_RECURSIVE:-off}
      PROXY_READ_TIMEOUT: ${PROXY_READ_TIMEOUT:-120}
      CLIENT_MAX_BODY_SIZE: ${CLIENT_MAX_BODY_SIZE:-50m}
    
    command:
      - nginx-entrypoint.sh
    
    depends_on:
      - backend
      - websocket
    
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-frontend"
  
  # =================================================================
  # WebSocket Server
  # =================================================================
  # Handles real-time communication for ERPNext features
  # Required for live notifications, real-time updates, and chat
  websocket:
    <<: *backend_defaults
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_websocket
    
    deploy:
      resources:
        limits:
          cpus: '${WEBSOCKET_CPU_LIMIT:-0.5}'
          memory: ${WEBSOCKET_MEMORY_LIMIT:-512M}
      restart_policy:
        condition: on-failure
    
    environment:
      <<: *redis_environment
    
    command:
      - node
      - /home/frappe/frappe-bench/apps/frappe/socketio.js
    
    depends_on:
      configurator:
        condition: service_completed_successfully

  # =================================================================
  # Queue Workers
  # =================================================================
  # Process background jobs for ERPNext
  # Long queue handles: Email, Reports, Data Import/Export
  queue-long:
    <<: *backend_defaults
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_queue_long
    
    deploy:
      resources:
        limits:
          cpus: '${QUEUE_CPU_LIMIT:-1.0}'
          memory: ${QUEUE_MEMORY_LIMIT:-2G}
      restart_policy:
        condition: on-failure
    
    environment:
      <<: *redis_environment
    
    command: bench worker --queue long,default,short
    
    depends_on:
      configurator:
        condition: service_completed_successfully

  # Short queue handles: Quick operations, Realtime updates
  queue-short:
    <<: *backend_defaults
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_queue_short
    
    deploy:
      resources:
        limits:
          cpus: '${QUEUE_CPU_LIMIT:-0.5}'
          memory: ${QUEUE_MEMORY_LIMIT:-1G}
      restart_policy:
        condition: on-failure
    
    environment:
      <<: *redis_environment
    
    command: bench worker --queue short,default
    
    depends_on:
      configurator:
        condition: service_completed_successfully

  # =================================================================
  # Scheduler Service
  # =================================================================
  # Runs scheduled tasks: Daily backups, Email digest, Recurring invoices
  scheduler:
    <<: *backend_defaults
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_scheduler
    
    deploy:
      resources:
        limits:
          cpus: '${SCHEDULER_CPU_LIMIT:-0.5}'
          memory: ${SCHEDULER_MEMORY_LIMIT:-1G}
      restart_policy:
        condition: on-failure
    
    command: bench schedule
    
    depends_on:
      configurator:
        condition: service_completed_successfully

  # =================================================================
  # MariaDB Database Server
  # =================================================================
  # Primary data storage for ERPNext
  # MariaDB 10.6 is officially recommended by Frappe for v16
  db:
    image: mariadb:${DB_VERSION:-10.6}
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_database
    
    restart: ${RESTART_POLICY:-unless-stopped}
    
    networks:
      - frappe_network
    
    deploy:
      resources:
        limits:
          cpus: '${DB_CPU_LIMIT:-2.0}'
          memory: ${DB_MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${DB_CPU_RESERVE:-0.5}'
          memory: ${DB_MEMORY_RESERVE:-512M}
      restart_policy:
        condition: on-failure
    
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "--password=${DB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    security_opt:
      - no-new-privileges:true
    
    # Database optimization parameters for ERPNext
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --skip-innodb-read-only-compressed
      # Performance optimizations
      - --innodb-buffer-pool-size=${DB_INNODB_BUFFER_POOL_SIZE:-2G}
      - --innodb-log-file-size=${DB_INNODB_LOG_FILE_SIZE:-256M}
      - --max-connections=${DB_MAX_CONNECTIONS:-200}
      # Disable query cache (deprecated in MariaDB 10.6+)
      - --query-cache-type=0
      - --query-cache-size=0
    
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      TZ: ${TIMEZONE:-UTC}
    
    volumes:
      - erpnext_db_data:/var/lib/mysql:rw
    
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-database"
  
  # =================================================================
  # Redis Cache Server
  # =================================================================
  # Handles session storage, object caching, and temporary data
  redis-cache:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_redis_cache
    
    restart: ${RESTART_POLICY:-unless-stopped}
    
    networks:
      - frappe_network
    
    deploy:
      resources:
        limits:
          cpus: '${REDIS_CPU_LIMIT:-1.0}'
          memory: ${REDIS_CACHE_MEMORY_LIMIT:-1G}
        reservations:
          cpus: '0.1'
          memory: 128M
      restart_policy:
        condition: on-failure
    
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    
    security_opt:
      - no-new-privileges:true
    
    # Redis optimization for caching workload
    command:
      - redis-server
      - --maxmemory
      - ${REDIS_CACHE_MAXMEMORY:-512mb}
      - --maxmemory-policy
      - allkeys-lru
      - --save
      - ""
      - --appendonly
      - "no"
    
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-redis-cache"
  
  # =================================================================
  # Redis Queue Server
  # =================================================================
  # Handles background job processing, email sending, and scheduled tasks
  redis-queue:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_redis_queue
    
    restart: ${RESTART_POLICY:-unless-stopped}
    
    networks:
      - frappe_network
    
    deploy:
      resources:
        limits:
          cpus: '${REDIS_CPU_LIMIT:-0.5}'
          memory: ${REDIS_QUEUE_MEMORY_LIMIT:-512M}
      restart_policy:
        condition: on-failure
    
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    
    security_opt:
      - no-new-privileges:true
    
    # Queue-optimized Redis configuration with persistence
    command:
      - redis-server
      - --maxmemory
      - ${REDIS_QUEUE_MAXMEMORY:-256mb}
      - --maxmemory-policy
      - noeviction
      - --appendonly
      - "yes"
      - --appendfsync
      - everysec
    
    volumes:
      - erpnext_redis_queue:/data
    
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-redis-queue"

# =================================================================
# NETWORKS
# =================================================================
networks:
  frappe_network:
    name: ${COMPOSE_PROJECT_NAME:-erpnext}_network
    driver: bridge

# =================================================================
# PERSISTENT VOLUMES
# =================================================================
# Critical data storage for ERPNext operation
# These volumes contain all your business data and must be backed up
volumes:
  # ERPNext sites data - Contains all site configurations, files, and uploads
  erpnext_sites:
    name: ${COMPOSE_PROJECT_NAME:-erpnext}_sites_data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/sites
  
  # Application and system logs
  erpnext_logs:
    name: ${COMPOSE_PROJECT_NAME:-erpnext}_logs
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/logs
  
  # Database storage - Contains all ERPNext business data
  erpnext_db_data:
    name: ${COMPOSE_PROJECT_NAME:-erpnext}_db_data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/db
  
  # Redis queue persistence - Background jobs and queue data
  erpnext_redis_queue:
    name: ${COMPOSE_PROJECT_NAME:-erpnext}_redis_queue
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/redis_queue

# =================================================================
# PRODUCTION DEPLOYMENT NOTES (Debian 12 + Host Nginx)
# =================================================================
# 1. HOST NGINX CONFIGURATION:
#    Configure your host Nginx to proxy to frontend:8080
#    See SETUP.md for example configuration
#
# 2. SSL TERMINATION:
#    Handle SSL at host Nginx level, not in Docker containers
#    Use Let's Encrypt with Certbot for free SSL certificates
#
# 3. FIREWALL CONFIGURATION:
#    Allow only ports 80, 443 externally
#    Block direct access to port 8080
#
# 4. BACKUP STRATEGY:
#    Regular backups of: erpnext_sites, erpnext_db_data
#    Use: docker compose exec backend bench --site <site> backup --with-files
#
# 5. UPGRADES:
#    v15 to v16: Run bench migrate after updating image versions
#    Always backup before upgrading
# =================================================================
