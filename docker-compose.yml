# ERPNext Production Docker Compose Configuration
# =================================================================
# Production-ready Docker Compose setup for ERPNext v15.83.0
# Based on official Frappe Docker repository guidelines
# Optimized for Debian 12 with host-level Nginx reverse proxy
# 
# Architecture:
# - ERPNext Backend (Gunicorn application server)
# - ERPNext Frontend (Nginx web server)
# - MariaDB (Database - officially recommended by Frappe)
# - Redis Cache (Session and object caching)
# - Redis Queue (Background job processing)
# - Configurator (Initial setup and site management)
# =================================================================

# Docker Compose version 2.x syntax (no version field needed)
# Uses modern Docker Compose features and best practices
name: erpnext-production

services:
  # =================================================================
  # ERPNext Backend Application Server
  # =================================================================
  # Handles API requests, web interface, and business logic
  # Runs Gunicorn WSGI server with Frappe framework
  backend:
    # Use specific version tag for production stability
    # v15.83.0 is the latest stable release as of October 2025
    image: frappe/erpnext:v${ERPNEXT_VERSION:-15.83.0}
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_backend
    
    # Always restart unless explicitly stopped
    # Essential for production uptime and automatic recovery
    restart: unless-stopped
    
    # Security: Run as non-root user (frappe user inside container)
    # The official ERPNext image already configures this correctly
    user: "1000:1000"
    
    # Network configuration for service communication and reverse proxy
    networks:
      - erpnext_frontend  # Communication with nginx proxy
      - erpnext_backend   # Database and cache communication
    
    # Production resource limits to prevent resource exhaustion
    # Adjust based on your server specifications and load requirements
    deploy:
      resources:
        limits:
          cpus: '${BACKEND_CPU_LIMIT:-2.0}'
          memory: ${BACKEND_MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${BACKEND_CPU_RESERVE:-0.5}'
          memory: ${BACKEND_MEMORY_RESERVE:-1G}
    
    # Health check to monitor application status
    # Enables automatic restart on failure and load balancer health checks
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/method/frappe.utils.get_site_info || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Allow extra time for ERPNext to fully initialize
    
    # Security hardening options
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    
    # Expose internal port for frontend service communication
    # Port 8000 is the standard Gunicorn port for ERPNext
    expose:
      - "8000"
    
    # Persistent storage for ERPNext sites and application logs
    # Critical: Contains all your business data and configurations
    volumes:
      - erpnext_sites:/home/frappe/frappe-bench/sites:rw
      - erpnext_logs:/home/frappe/frappe-bench/logs:rw
      # Optional: Custom apps and configurations
      # - ./custom_apps:/home/frappe/frappe-bench/apps/custom:ro
    
    # Environment variables for ERPNext configuration
    # Most sensitive values come from .env file
    environment:
      # Database connection configuration
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      
      # Redis configuration for caching and job queue
      REDIS_CACHE: "redis-cache:6379"
      REDIS_QUEUE: "redis-queue:6379"
      
      # ERPNext application settings
      FRAPPE_SITE_NAME_HEADER: ${SITE_NAME}
      DEVELOPER_MODE: ${DEVELOPER_MODE:-0}
      
      # Performance tuning
      WORKER_CLASS: ${WORKER_CLASS:-sync}
      WORKERS: ${BACKEND_WORKERS:-4}
      TIMEOUT: ${BACKEND_TIMEOUT:-300}
    
    # Service dependencies - ensure infrastructure is ready
    depends_on:
      db:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
      redis-queue:
        condition: service_healthy
    
    # Logging configuration for production monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-backend"
  
  # =================================================================
  # ERPNext Frontend Web Server
  # =================================================================
  # Nginx server for static files and reverse proxy to backend
  # Handles file uploads, static assets, and HTTP request routing
  frontend:
    # Same image as backend but runs nginx-entrypoint.sh
    image: frappe/erpnext:v${ERPNEXT_VERSION:-15.83.0}
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_frontend
    
    restart: unless-stopped
    user: "1000:1000"
    
    # Frontend only needs access to proxy network and backend communication
    networks:
      - erpnext_frontend
    
    # Resource limits for nginx frontend (typically lighter than backend)
    deploy:
      resources:
        limits:
          cpus: '${FRONTEND_CPU_LIMIT:-1.0}'
          memory: ${FRONTEND_MEMORY_LIMIT:-1G}
        reservations:
          cpus: '${FRONTEND_CPU_RESERVE:-0.25}'
          memory: ${FRONTEND_MEMORY_RESERVE:-256M}
    
    # Health check for nginx web server
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/api/method/ping || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    
    security_opt:
      - no-new-privileges:true
    
    # Expose port for host nginx reverse proxy
    # This port will be accessed by your host-level Nginx
    # Port can be customized via FRONTEND_PORT in .env file
    ports:
      - "${FRONTEND_PORT:-8080}:8080"
    
    # Share sites volume for static file serving
    volumes:
      - erpnext_sites:/home/frappe/frappe-bench/sites:ro
      - erpnext_logs:/home/frappe/frappe-bench/logs:rw
    
    # Nginx-specific configuration
    environment:
      # Backend server for reverse proxy
      BACKEND: backend:8000
      SOCKETIO: websocket:9000
      
      # Nginx performance settings
      CLIENT_MAX_BODY_SIZE: ${MAX_UPLOAD_SIZE:-50m}
      PROXY_READ_TIMEOUT: ${PROXY_TIMEOUT:-300}
      
      # Enable gzip compression for better performance
      GZIP_COMPRESSION: "on"
    
    # Override default command to run nginx
    command: ["nginx-entrypoint.sh"]
    
    depends_on:
      backend:
        condition: service_healthy
      websocket:
        condition: service_started
    
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-frontend"
  
  # =================================================================
  # WebSocket Server
  # =================================================================
  # Handles real-time communication for ERPNext features
  # Required for live notifications, real-time updates, and chat
  websocket:
    image: frappe/erpnext:v${ERPNEXT_VERSION:-15.83.0}
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_websocket
    
    restart: unless-stopped
    user: "1000:1000"
    
    networks:
      - erpnext_frontend
      - erpnext_backend
    
    deploy:
      resources:
        limits:
          cpus: '${WEBSOCKET_CPU_LIMIT:-0.5}'
          memory: ${WEBSOCKET_MEMORY_LIMIT:-512M}
        reservations:
          cpus: '0.1'
          memory: 128M
    
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    
    security_opt:
      - no-new-privileges:true
    
    expose:
      - "9000"
    
    volumes:
      - erpnext_sites:/home/frappe/frappe-bench/sites:ro
      - erpnext_logs:/home/frappe/frappe-bench/logs:rw
    
    environment:
      # Same database and redis configuration as backend
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
      REDIS_CACHE: "redis-cache:6379"
      REDIS_QUEUE: "redis-queue:6379"
      FRAPPE_SITE_NAME_HEADER: ${SITE_NAME}
    
    # WebSocket specific startup command
    command: ["node", "/home/frappe/frappe-bench/apps/frappe/socketio.js"]
    
    depends_on:
      db:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-websocket"
  
  # =================================================================
  # MariaDB Database Server
  # =================================================================
  # Primary data storage for ERPNext
  # MariaDB is officially recommended over PostgreSQL for ERPNext
  # Provides better compatibility and performance for Frappe framework
  db:
    # Use MariaDB 10.11 LTS for stability and long-term support
    # This version is well-tested with ERPNext and provides security updates
    image: mariadb:${DB_VERSION:-10.11}
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_database
    
    restart: unless-stopped
    
    # Run database in backend network only (no external access)
    networks:
      - erpnext_backend
    
    # Database needs significant resources for good performance
    deploy:
      resources:
        limits:
          cpus: '${DB_CPU_LIMIT:-2.0}'
          memory: ${DB_MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${DB_CPU_RESERVE:-0.5}'
          memory: ${DB_MEMORY_RESERVE:-1G}
    
    # Critical health check for database availability
    # ERPNext cannot function without database connection
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    security_opt:
      - no-new-privileges:true
    
    # Database optimization parameters for ERPNext
    # These settings improve performance and compatibility
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --skip-innodb-read-only-compressed
      # Performance optimizations for production
      - --innodb-buffer-pool-size=${DB_INNODB_BUFFER_POOL_SIZE:-2G}
      - --innodb-log-file-size=${DB_INNODB_LOG_FILE_SIZE:-256M}
      - --max-connections=${DB_MAX_CONNECTIONS:-200}
      - --query-cache-size=${DB_QUERY_CACHE_SIZE:-64M}
      - --query-cache-type=1
      # Security settings
      - --bind-address=0.0.0.0
    
    # Database credentials from environment variables
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      # Timezone configuration
      TZ: ${TIMEZONE:-UTC}
    
    # Persistent database storage - CRITICAL for data preservation
    volumes:
      - erpnext_db_data:/var/lib/mysql:rw
      # Optional: Custom MySQL configuration
      # - ./mysql/conf.d:/etc/mysql/conf.d:ro
      # Optional: Database initialization scripts
      # - ./mysql/init:/docker-entrypoint-initdb.d:ro
    
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-database"
  
  # =================================================================
  # Redis Cache Server
  # =================================================================
  # Handles session storage, object caching, and temporary data
  # Significantly improves ERPNext performance and user experience
  redis-cache:
    # Use Redis 7 Alpine for smaller footprint and security updates
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_redis_cache
    
    restart: unless-stopped
    
    # Redis runs as non-root user in Alpine image
    networks:
      - erpnext_backend
    
    deploy:
      resources:
        limits:
          cpus: '${REDIS_CPU_LIMIT:-1.0}'
          memory: ${REDIS_CACHE_MEMORY_LIMIT:-1G}
        reservations:
          cpus: '0.1'
          memory: 128M
    
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 30s
    
    security_opt:
      - no-new-privileges:true
    
    # Redis optimization for caching workload
    command: 
      - redis-server
      - --maxmemory
      - ${REDIS_CACHE_MAXMEMORY:-512mb}
      - --maxmemory-policy
      - allkeys-lru
      - --save
      - ""  # Disable persistence for cache (optional)
      - --appendonly
      - "no"
    
    # Optional persistent storage for cache (comment out for pure cache)
    # volumes:
    #   - erpnext_redis_cache:/data
    
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-redis-cache"
  
  # =================================================================
  # Redis Queue Server
  # =================================================================
  # Handles background job processing, email sending, and scheduled tasks
  # Separate from cache to prevent job loss during cache evictions
  redis-queue:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_redis_queue
    
    restart: unless-stopped
    
    networks:
      - erpnext_backend
    
    deploy:
      resources:
        limits:
          cpus: '${REDIS_CPU_LIMIT:-0.5}'
          memory: ${REDIS_QUEUE_MEMORY_LIMIT:-512M}
        reservations:
          cpus: '0.1'
          memory: 64M
    
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 30s
    
    security_opt:
      - no-new-privileges:true
    
    # Queue-optimized Redis configuration
    # Persistence enabled to prevent job loss
    command:
      - redis-server
      - --maxmemory
      - ${REDIS_QUEUE_MAXMEMORY:-256mb}
      - --maxmemory-policy
      - noeviction  # Never evict queue jobs
      - --appendonly
      - "yes"
      - --appendfsync
      - everysec
    
    # Persistent storage for job queue (important for reliability)
    volumes:
      - erpnext_redis_queue:/data
    
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-redis-queue"
  
  # =================================================================
  # ERPNext Configurator and Site Management
  # =================================================================
  # Handles initial setup, site creation, and configuration management
  # Runs once during deployment or when configuration changes are needed
  configurator:
    image: frappe/erpnext:v${ERPNEXT_VERSION:-15.83.0}
    container_name: ${COMPOSE_PROJECT_NAME:-erpnext}_configurator
    
    # Run only when explicitly needed (not automatically restarted)
    restart: "no"
    
    user: "1000:1000"
    
    networks:
      - erpnext_backend
    
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    
    security_opt:
      - no-new-privileges:true
    
    volumes:
      - erpnext_sites:/home/frappe/frappe-bench/sites:rw
      - erpnext_logs:/home/frappe/frappe-bench/logs:rw
    
    environment:
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
      DB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      REDIS_CACHE: "redis-cache:6379"
      REDIS_QUEUE: "redis-queue:6379"
      FRAPPE_SITE_NAME_HEADER: ${SITE_NAME}
    
    # Site configuration and setup commands
    # This runs the initial ERPNext installation
    entrypoint: ["bash", "-c"]
    command:
      - |
        # Wait for database to be ready
        echo "Waiting for database to be ready..."
        until mysqladmin ping -h $$DB_HOST -P $$DB_PORT -u root -p$$DB_ROOT_PASSWORD --silent; do
          echo "Database not ready, waiting..."
          sleep 5
        done
        
        # Wait for Redis services
        echo "Waiting for Redis services..."
        until redis-cli -h redis-cache ping; do sleep 2; done
        until redis-cli -h redis-queue ping; do sleep 2; done
        
        # Configure Frappe framework
        echo "Configuring Frappe framework..."
        bench set-config -g db_host $$DB_HOST
        bench set-config -g db_port $$DB_PORT
        bench set-config -g redis_cache "redis://redis-cache:6379"
        bench set-config -g redis_queue "redis://redis-queue:6379"
        bench set-config -g redis_socketio "redis://redis-cache:6379"
        
        # Create site if it doesn't exist
        if [ ! -f "sites/${SITE_NAME}/site_config.json" ]; then
          echo "Creating new site: ${SITE_NAME}"
          bench new-site ${SITE_NAME} \
            --mariadb-user-host-login-scope='%' \
            --admin-password="${ADMIN_PASSWORD}" \
            --db-root-username=root \
            --db-root-password="$$DB_ROOT_PASSWORD" \
            --install-app erpnext \
            --set-default
        else
          echo "Site ${SITE_NAME} already exists"
        fi
        
        echo "Configuration completed successfully"
    
    depends_on:
      db:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
      redis-queue:
        condition: service_healthy
    
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILES:-5}"
        labels: "service=erpnext-configurator"

# =================================================================
# DOCKER NETWORKS
# =================================================================
# Network isolation for security and performance
# Frontend network: Communication between services and reverse proxy
# Backend network: Internal service communication (database, cache)
networks:
  # Frontend network for reverse proxy integration
  # This network connects to your host-level Nginx
  erpnext_frontend:
    name: ${COMPOSE_PROJECT_NAME:-erpnext}_frontend
    driver: bridge
    ipam:
      config:
        - subnet: ${FRONTEND_SUBNET:-172.20.0.0/24}
    driver_opts:
      com.docker.network.bridge.name: br-erpnext-front
  
  # Backend network for internal services
  # Isolated from external access for security
  erpnext_backend:
    name: ${COMPOSE_PROJECT_NAME:-erpnext}_backend
    driver: bridge
    internal: true  # No external internet access
    ipam:
      config:
        - subnet: ${BACKEND_SUBNET:-172.21.0.0/24}
    driver_opts:
      com.docker.network.bridge.name: br-erpnext-back

# =================================================================
# PERSISTENT VOLUMES
# =================================================================
# Critical data storage for ERPNext operation
# These volumes contain all your business data and must be backed up
volumes:
  # ERPNext sites data - Contains all site configurations, files, and uploads
  # CRITICAL: This contains all your business data
  erpnext_sites:
    name: ${COMPOSE_PROJECT_NAME:-erpnext}_sites_data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/sites
  
  # Application and system logs
  erpnext_logs:
    name: ${COMPOSE_PROJECT_NAME:-erpnext}_logs
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/logs
  
  # Database storage - Contains all ERPNext business data
  # CRITICAL: Most important volume - contains all your data
  erpnext_db_data:
    name: ${COMPOSE_PROJECT_NAME:-erpnext}_db_data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/db
  
  # Redis queue persistence - Background jobs and queue data
  # Important for preventing job loss during restarts
  erpnext_redis_queue:
    name: ${COMPOSE_PROJECT_NAME:-erpnext}_redis_queue
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/redis_queue

# =================================================================
# PRODUCTION DEPLOYMENT NOTES
# =================================================================
# 1. HOST NGINX CONFIGURATION:
#    Configure your host Nginx to proxy to frontend:8080
#    Example location block:
#    location / {
#        proxy_pass http://localhost:8080;
#        proxy_set_header Host $host;
#        proxy_set_header X-Real-IP $remote_addr;
#        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#        proxy_set_header X-Forwarded-Proto $scheme;
#    }
#
# 2. SSL TERMINATION:
#    Handle SSL at host Nginx level, not in Docker containers
#    Use Let's Encrypt or your preferred SSL certificate provider
#
# 3. FIREWALL CONFIGURATION:
#    Only expose necessary ports on host (80, 443)
#    Block direct access to Docker ports
#
# 4. BACKUP STRATEGY:
#    Regular backups of volumes: erpnext_sites, erpnext_db_data
#    Test backup restoration procedures regularly
#
# 5. MONITORING:
#    Monitor container health, resource usage, and logs
#    Set up alerts for service failures or resource exhaustion
#
# 6. UPDATES:
#    Plan regular updates for security and features
#    Test updates in staging environment first
#    Always backup before updating
# =================================================================