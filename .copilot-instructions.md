# GitHub Copilot Instructions for ERPNext Docker Production Deployment

## üéØ Project Context

This project is a **production-ready Docker deployment configuration** for ERPNext, based on the official [Frappe Docker](https://github.com/frappe/frappe_docker) guidelines. The target environment is a **Debian 12 server** with host-level Nginx reverse proxy for SSL termination and load balancing.

### Project Objectives
- Deploy ERPNext in a secure, scalable Docker environment
- Follow Docker Compose v2.x best practices
- Integrate with existing Nginx reverse proxy infrastructure
- Maintain high security standards and operational efficiency
- Provide comprehensive documentation and maintainability

## üìã Mandatory Requirements

### Docker Standards
- **ALWAYS use Docker Compose v2.x syntax** (no version field in compose files)
- **Use latest stable Docker Compose features** and syntax
- **Implement health checks** for all services
- **Configure resource limits** (CPU, memory) for all containers
- **Use multi-stage builds** when creating custom Dockerfiles
- **Never run containers as root** unless absolutely necessary

### Security Requirements (NON-NEGOTIABLE)
- **All passwords must be environment variables** - never hardcode credentials
- **Use Docker secrets** for sensitive data when possible
- **Implement network isolation** with custom Docker networks
- **Configure read-only filesystems** where applicable
- **Set security options** (no-new-privileges, user namespaces)
- **Use official, minimal base images** (Alpine when possible)
- **Regular security updates** must be considered in all configurations

### Code Quality Standards
- **All files must be in English** - no exceptions
- **Extensive comments required** - explain WHY, not just WHAT
- **Use meaningful variable names** and consistent naming conventions
- **Include inline documentation** for complex configurations
- **YAML files must be properly indented** (2 spaces, no tabs)
- **Environment variables must be uppercase** with descriptive names

## üõ†Ô∏è Technical Guidelines

### Docker Compose Best Practices
```yaml
# ALWAYS include these headers in docker-compose.yml
# Docker Compose file for ERPNext production deployment
# Follow security best practices and maintain compatibility
# with host-level Nginx reverse proxy configuration

services:
  service_name:
    # Always specify exact image tags, avoid 'latest' in production
    image: frappe/erpnext:v14.27.0
    
    # Always include container name for better management
    container_name: erpnext_app
    
    # Configure restart policy for production resilience
    restart: unless-stopped
    
    # Implement health checks for monitoring
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Set resource limits to prevent resource exhaustion
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    
    # Configure security options
    security_opt:
      - no-new-privileges:true
    
    # Use non-root user when possible
    user: "1000:1000"
```

### Environment Variables Structure
```bash
# Database Configuration - REQUIRED
# Use strong, unique passwords for all database accounts
DB_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-}  # Minimum 16 characters
DB_PASSWORD=${DB_PASSWORD:-}            # Different from root password
DB_NAME=${DB_NAME:-erpnext_production}
DB_USER=${DB_USER:-erpnext_user}
DB_HOST=${DB_HOST:-db}
DB_PORT=${DB_PORT:-3306}

# ERPNext Application Configuration - REQUIRED
SITE_NAME=${SITE_NAME:-}                    # Primary domain name
ADMIN_PASSWORD=${ADMIN_PASSWORD:-}          # ERPNext admin password
SECRET_KEY=${SECRET_KEY:-}                  # Encryption key (32+ chars)

# Network and Proxy Configuration - REQUIRED
VIRTUAL_HOST=${VIRTUAL_HOST:-${SITE_NAME}}
LETSENCRYPT_HOST=${LETSENCRYPT_HOST:-${SITE_NAME}}
LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}

# Performance Tuning - OPTIONAL
WORKER_PROCESSES=${WORKER_PROCESSES:-4}
MAX_WORKER_CONNECTIONS=${MAX_WORKER_CONNECTIONS:-1024}
REDIS_MAXMEMORY=${REDIS_MAXMEMORY:-512mb}

# Backup Configuration - RECOMMENDED
BACKUP_SCHEDULE=${BACKUP_SCHEDULE:-0 2 * * *}  # Daily at 2 AM
BACKUP_RETENTION=${BACKUP_RETENTION:-7}         # Keep 7 days
```

### Network Configuration
```yaml
# ALWAYS create custom networks for service isolation
networks:
  # Frontend network for proxy communication
  erpnext_frontend:
    name: erpnext_frontend
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  
  # Backend network for internal service communication
  erpnext_backend:
    name: erpnext_backend
    driver: bridge
    internal: true  # No external access
    ipam:
      config:
        - subnet: 172.21.0.0/24
```

### Volume Management
```yaml
volumes:
  # Database persistent storage with explicit driver
  db_data:
    name: erpnext_db_data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/erpnext/data/db
  
  # Application data with proper permissions
  sites_data:
    name: erpnext_sites_data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/erpnext/data/sites
  
  # Logs volume for centralized logging
  logs_data:
    name: erpnext_logs
    driver: local
```

## üö´ What NOT to Do

### Forbidden Practices
- **NEVER hardcode passwords** or sensitive information
- **NEVER use 'latest' tags** in production configurations
- **NEVER expose database ports** to the host or external networks
- **NEVER run containers with privileged mode** unless absolutely necessary
- **NEVER skip health checks** - they are mandatory for production services
- **NEVER write shell scripts** unless explicitly requested by the user
- **NEVER use deprecated Docker Compose syntax** (version 1.x)

### Avoid These Patterns
```yaml
# ‚ùå BAD - Hardcoded credentials
environment:
  - MYSQL_ROOT_PASSWORD=admin123
  
# ‚ùå BAD - Using 'latest' tag
image: frappe/erpnext:latest

# ‚ùå BAD - No resource limits
# (Missing deploy section with resource constraints)

# ‚ùå BAD - Exposing internal services
ports:
  - "3306:3306"  # Database should not be exposed

# ‚ùå BAD - Running as root
user: root
```

### Preferred Patterns
```yaml
# ‚úÖ GOOD - Environment variable for credentials
environment:
  - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
  
# ‚úÖ GOOD - Specific version tag
image: frappe/erpnext:v14.27.0

# ‚úÖ GOOD - Resource limits configured
deploy:
  resources:
    limits:
      memory: 2G
    reservations:
      memory: 512M

# ‚úÖ GOOD - Internal networking only
networks:
  - backend  # No external exposure

# ‚úÖ GOOD - Non-root user
user: "1001:1001"
```

## üìù Documentation Standards

### Comments Requirements
- **Every service must have a description comment**
- **Explain WHY a configuration choice was made**
- **Document any deviations from defaults**
- **Include links to relevant documentation**
- **Warn about potential security implications**

### Comment Format
```yaml
# ERPNext Application Server
# Handles web requests and background jobs
# Configured with production-optimized settings
# Security: Runs as non-root user with resource limits
# Reference: https://github.com/frappe/frappe_docker
services:
  erpnext:
    # Use specific version for production stability
    # Update version in .env file for controlled upgrades
    image: frappe/erpnext:${ERPNEXT_VERSION:-v14.27.0}
```

## üéØ Nginx Integration Guidelines

### Host-Level Nginx Configuration
Since the target server has Nginx running at the host level, all configurations must:
- **Use internal Docker networks** - no direct port exposure
- **Configure proper upstream blocks** in host Nginx
- **Handle SSL termination at host level**
- **Implement proper proxy headers**
- **Configure rate limiting and security headers**

### Docker Service Exposure
```yaml
# ERPNext service should only expose to internal network
services:
  erpnext:
    # NO ports section - use networks only
    networks:
      - erpnext_frontend  # Connect to proxy network
      - erpnext_backend   # Connect to database network
    
    # Configure internal port for proxy communication
    expose:
      - "8000"  # Internal port only
```

## üîç Monitoring and Logging

### Required Monitoring Components
- **Health checks for all services** (mandatory)
- **Log rotation configuration** (mandatory)
- **Resource usage monitoring** (recommended)
- **Alert configuration** (recommended)

### Logging Configuration
```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"      # Prevent log files from growing too large
    max-file: "5"        # Keep last 5 log files
    labels: "service"    # Include service labels in logs
```

## üì¶ File Organization

### Required Directory Structure
```
erpnext-docker/
‚îú‚îÄ‚îÄ docker-compose.yml              # Main production configuration
‚îú‚îÄ‚îÄ .env.example                   # Environment template with examples
‚îú‚îÄ‚îÄ .env                          # Actual environment (git-ignored)
‚îú‚îÄ‚îÄ .gitignore                    # Comprehensive gitignore file
‚îú‚îÄ‚îÄ nginx/                        # Container nginx configuration
‚îú‚îÄ‚îÄ backups/                      # Backup scripts and storage
‚îú‚îÄ‚îÄ logs/                        # Log file storage
‚îú‚îÄ‚îÄ data/                        # Persistent data volumes
‚îî‚îÄ‚îÄ docs/                        # Additional documentation
```

### Required Files
1. **docker-compose.yml** - Main service configuration
2. **.env.example** - Complete environment template
3. **.gitignore** - Protect sensitive files
4. **README.md** - Comprehensive documentation
5. **SECURITY.md** - Security guidelines and procedures

## üéñÔ∏è Quality Assurance Checklist

Before suggesting any configuration, ensure:
- [ ] All services have health checks configured
- [ ] Resource limits are set for all containers
- [ ] No sensitive data is hardcoded
- [ ] Network isolation is properly implemented
- [ ] Comments explain the reasoning behind choices
- [ ] Docker Compose v2.x syntax is used
- [ ] Security best practices are followed
- [ ] Integration with host Nginx is considered
- [ ] Backup and recovery procedures are documented
- [ ] All text is in English with proper grammar

## üö® Emergency Procedures

### When Issues Arise
1. **Always check logs first**: `docker compose logs -f [service]`
2. **Verify environment variables**: Ensure all required variables are set
3. **Check network connectivity**: Verify Docker networks and proxy configuration
4. **Review resource usage**: Monitor CPU, memory, and disk space
5. **Consult documentation**: Reference official Frappe Docker documentation

### Recovery Commands
```bash
# Stop all services safely
docker compose down --remove-orphans

# Clean up resources
docker system prune -f

# Restart with fresh configuration
docker compose up -d

# Monitor startup process
docker compose logs -f
```

---

**Remember**: This is a production environment. Every change must prioritize security, reliability, and maintainability. When in doubt, choose the more secure option and document the decision thoroughly.